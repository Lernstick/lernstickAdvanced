From 8c60df6998f3c3d17b3d9ecdab8828261145914c Mon Sep 17 00:00:00 2001
From: Ronny Standtke <ronny.standtke@gmx.net>
Date: Fri, 5 Jan 2018 16:22:12 +0100
Subject: [PATCH] improved mksquashfs (use -Xbcj x86, show progress, be nice)

---
 scripts/build/binary_rootfs | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/scripts/build/binary_rootfs b/scripts/build/binary_rootfs
index 6c797acb3..24f421878 100755
--- a/scripts/build/binary_rootfs
+++ b/scripts/build/binary_rootfs
@@ -318,8 +318,6 @@ case "${LB_CHROOT_FILESYSTEM}" in
 		# Remove stale squashfs image
 		rm -f chroot/filesystem.squashfs
 
-		MKSQUASHFS_OPTIONS="${MKSQUASHFS_OPTIONS} -no-progress"
-
 		if [ "${_VERBOSE}" = "true" ]
 		then
 			MKSQUASHFS_OPTIONS="${MKSQUASHFS_OPTIONS} -info"
@@ -340,7 +338,7 @@ case "${LB_CHROOT_FILESYSTEM}" in
 			esac
 		fi
 
-		MKSQUASHFS_OPTIONS="${MKSQUASHFS_OPTIONS} -comp xz"
+		MKSQUASHFS_OPTIONS="${MKSQUASHFS_OPTIONS} -comp xz -Xbcj x86"
 
 		case "${LB_BUILD_WITH_CHROOT}" in
 			true)
@@ -352,7 +350,7 @@ case "${LB_CHROOT_FILESYSTEM}" in
 				fi
 
 				# Create image
-				Chroot chroot "mksquashfs chroot filesystem.squashfs ${MKSQUASHFS_OPTIONS}"
+				Chroot chroot "nice -n 19 mksquashfs chroot filesystem.squashfs ${MKSQUASHFS_OPTIONS}"
 
 				rm -f chroot/chroot/excludes
 
@@ -413,7 +411,7 @@ case "${LB_CHROOT_FILESYSTEM}" in
 					MKSQUASHFS_OPTIONS="${MKSQUASHFS_OPTIONS} -wildcards -ef config/rootfs/excludes"
 				fi
 
-				mksquashfs chroot binary/${INITFS}/filesystem.squashfs ${MKSQUASHFS_OPTIONS}
+				nice -n 19 mksquashfs chroot binary/${INITFS}/filesystem.squashfs ${MKSQUASHFS_OPTIONS}
 
 				du -B 1 -s chroot | cut -f1 > binary/${INITFS}/filesystem.size
 				;;
-- 
2.11.0

